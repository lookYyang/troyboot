<!DOCTYPE html>
<html lang="zh_CN" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro" xmlns:v-on="http://www.w3.org/1999/xhtml">
<head th:include="include :: header">
</head>
<body>
	<div id="content">
		<div class="ibox-content">
			<div class="row row-lg">
				<div class="col-sm-4">
					<h4 class="example-title">树菜单</h4>
					<div class="example">
						<Tree :data="treeData"></Tree>
					</div>
				</div>
				<div class="col-sm-8">
                    <div class="fixed-table-toolbar">
                        <div class="columns pull-left">
                            <i-button type="primary" @on-select="add">添加</i-button>
                            <i-button type="warning" @on-select="batchRemove">删除</i-button>
                        </div>
                    </div>
					<div class="ibox">
						<div class="ibox-body table-responsive">
							<i-table border stripe ref="selection" :columns="columns" :data="tableData" @on-select="onSelect"></i-table>
                            <Page :total="pageTotal" class="paging"/>
						</div>
					</div>
				</div>
			</div>
		</div>

        <Modal ref="modal" v-model="modal" :rules='ruleValidate' :title="formTitle" @on-ok="submit" @on-cancel="cancel" >
            <i-form ref="formValidate" :model="formItem" :label-width="80">
                <form-item label="名称" prop='required'>
                    <i-input v-model="formItem.name" placeholder="请输入名称..."></i-input>
                </form-item>
                <form-item label="权限" prop='required'>
                    <i-input v-model="formItem.permission" placeholder="请输入权限..."></i-input>
                </form-item>
                <form-item label="路径" prop='required'>
                    <i-input v-model="formItem.url" placeholder="请输入路径..."></i-input>
                </form-item>
                <form-item label="权限类型" prop='group'>
                    <i-select v-model="formItem.type" clearable>
                        <i-option v-for="item in perType" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                    </i-select>
                </form-item>
                <form-item label="排序" prop='required'>
                    <i-input v-model="formItem.sortNo" placeholder="请输入序号..." number></i-input>
                </form-item>
                <form-item label="图标">
                    <i-input v-model="formItem.icon" placeholder="请选择图标..."></i-input>
                </form-item>
                <form-item label="是否启用" prop='required'>
                    <i-switch v-model="formItem.isEnable" @on-change="change" />
                </form-item>
            </i-form>
        </Modal>

	</div>

	<div th:include="include::footer"></div>
<style scoped>
    .paging{
        float:left;
        margin-top:10px;
    }
</style>
<script>
    new Vue({
        el: '#content',
        data() {
            return {
                columns: [
                    {type: 'selection', align: 'center', width: 60},
                    {title: '名称', key: 'name'},
                    {title: '授权', key: 'permission'},
                    {title: '访问路径', key: 'url'},
                    {title: '节点类型', key: 'type', align: 'center'},
                    {title: '排序号', key: 'sortNo', sortable: true, align: 'center'},
                    {title: '图标', key: 'icon'},
                    {title: '是否启用', key: 'isEnable', align: 'center',
                        filters: [
                            {
                                label: '显示启用',
                                value: 1
                            },
                            {
                                label: '显示不启用',
                                value: 0
                            }
                        ],
                        filterMultiple: false,
                        filterMethod (value, row) {
                            if (value === 1) {
                                return row.isEnable = 1;
                            } else if (value === 0) {
                                return row.isEnable = 0;
                            }
                        },
                        render: (h, params) => {
                            let texts = '';
                            if(params.row.isEnable == 1){
                                texts = "是";
                            }else if(params.row.isEnable == 0) {
                                texts = "否";
                            }
                            return h('div', {
                                props: {},
                            },texts)
                        }
                    },
                    {
                        title: '操作',
                        key: 'action',
                        width: 150,
                        align: 'center',
                        render: (h, params) => {
                            return h('div', [
                                h('i-button', {
                                    props: {type: 'primary', size: 'small'},
                                    style: {
                                        marginRight: '5px'
                                    },
                                    on: {
                                        click: () => {
                                            this.edit(params.row)
                                        }
                                    }
                                }, '修改'),
                                h('i-button', {
                                    props: {type: 'error', size: 'small'},
                                    on: {
                                        click: () => {
                                            this.remove(params.row.id)
                                        }
                                    }
                                }, '删除')
                            ]);
                        }
                    }
                ],
                // 表格信息
                tableUrl: '/sys/permission/list',
                tableLoading: true,
                tableData: [],
                pageTotal: 1,
                // 树信息
                treeData: '',
                // 弹框信息
                modal: false,
                modalTitle: '',
                delModal: false,
                formItem: {
                    name: '',
                    permission: '',
                    url: '',
                    type: '',
                    sortNo: '',
                    icon: '',
                    isEnable: '',
                },
                ruleValidate:{
                    required:[{required: true, type: 'string', message: '', trigger: 'change'}],
                    group:[{required: true, type: 'string', message: '请选择分组', trigger: 'change'}],
                },
                // 下拉信息
                perType:[
                    {
                        value: '0',
                        label: '目录123'
                    },
                    {
                        value: '1',
                        label: '菜单'
                    },
                    {
                        value: '2',
                        label: '按钮'
                    },
                ],
                formTitle: '',
                delWarningMsg: '',
            }
        },
        computed:{

		},
		mounted (){
			this.initTree();
			this.initTable();
		},
        methods: {
            initTree() {
                var self = this;
                self.treeData = [
                    {title: 'parent 1', expand: true,
                        children: [
                            {title: 'parent 1-1', expand: true,
                                children: [{title: 'leaf 1-1-1'}, {title: 'leaf 1-1-2'}]
                            },
                            {title: 'parent 1-2', expand: true,
                                children: [{title: 'leaf 1-2-1'}, {title: 'leaf 1-2-1'}]
                            }
                        ]
                    }
                ];
			},
            initTable(){
                var self = this;
                self.tableLoading = true;
                $.ajax({
                    type : 'get',
                    url : Global.baseUrl + '/sys/permission/list',
                    data: {},
                    page: true,
                    success: function(data) {
                        if(_.isEqual(data.appcode, 200)){
                            self.tableData = data.rows;
                            self.pageTotal = data.total;
                            self.tableLoading = false;
                        }

                    }
                });
			},
			add() {
			    // TODO
                var self = this;
                self.formTitle = '权限新增';
                self.modal = true;
			},
            batchRemove() {
                var selRow = this.table.tableSelections();
                if(!_.isEmpty(selRow)){
                    var ids = [];
                    $.each(selRow, function(index, value){
                        ids.push(value.id);
                    });
                    this.delWarningMsg = "确定删除【"+ selRow.length +"】条记录吗？";
                    this.$Modal.confirm({
                        title: '删除权限',
                        content: this.delWarningMsg,
                        onOk: function(){
                            this.$Message.success('删除成功！');
                        },
                        onCancel: function(){}
                    });
                }else {
                    this.$Message.info({
                        content: '请选择删除内容',
                        duration: 2,
                        closable: true
                    });
                }
            },

            submit() {

            },
            cancel() {
                var self = this;
                self.$nextTick(function() {
                    self.$refs.formValidate.resetFields();
                });
            },
            change (status) {
                console.log('开关状态：' + status);
            },
            edit(row){
                var self = this;
                self.formTitle = '权限修改';
                self.formItem = row;
                self.modal = true;
            },
            remove(index){
                console.log(index);
            },
            onSelect(selection, row){
                console.log(selection, row);
            }
    }
    })
</script>
</body>
</html>